<header>
  <h1> Data Protection Impact Assessment </h1>

  <table class="dmp-data">
    {%- set projectNamePath = [uuids.adminDetailsCUuid, uuids.projectNameQUuid]|reply_path -%} 
    {%- set projectName = repliesMap[projectNamePath]|reply_str_value -%}
    
    {%- if projectName -%}
      <tr>
        <th>Project name</th>
        <td>{{ projectName }}</td>
      </tr>
    {%- endif -%} 

    <tr>
      <th>Organization</th>
      <td>{{ctx.organization.name}}</td>
    </tr>

    {% if ctx.createdBy %}
      <tr>
        <th>Created by</th>
        <td>{{ctx.createdBy.firstName}} {{ctx.createdBy.lastName}} (<a href="mailto:{{ctx.createdBy.email}}">{{ctx.createdBy.email}}</a>)</td>
      </tr>
    {% endif %}

    <tr>
      <th>Based on</th>
      <td>{{ctx.package.name}}, {{ctx.package.version}} (<span class="package-id"><span class="organization-id">{{ctx.package.organizationId}}</span>:<span class="km-id">{{ctx.package.kmId}}</span>:<span class="version">{{ctx.package.version}}</span></span>)</td>
    </tr>

    {% for version in ctx.questionnaireVersions if version.uuid == ctx.questionnaireVersion %}
      <tr>
        <th>Version</th>
        <td>{{version.name}} ({{ version.createdAt|datetime_format("%d %b %Y %H:%M:%S") }} UTC)</td>
      </tr>
    {% endfor %}

    {% if ctx.phaseUuid %}
      <tr>
        <th>Project Phase</th>
        <td>{{km.entities.phases[ctx.phaseUuid].title}}</td>
      </tr>
    {% endif %}

    <tr>
      <th>Created at</th>
      <td>{{ ctx.createdAt|datetime_format("%d %b %Y") }}</td>
    </tr>

    {%- set contributorsPath = [uuids.adminDetailsCUuid, uuids.contributorsQUuid]|reply_path -%}
    {%- set contributorsUuids = repliesMap[contributorsPath]|reply_items -%}
    {%- set nbrContributors = contributorsUuids|length -%}

    {%- for whichContributor in range(nbrContributors) -%}
      
      {%- set contributorUuid = contributorsUuids[whichContributor] -%}
      {%- set contributorPath = [uuids.adminDetailsCUuid, uuids.contributorsQUuid, contributorUuid]|reply_path -%}
      {%- set contributorNamePath = [uuids.adminDetailsCUuid, uuids.contributorsQUuid, contributorUuid, uuids.contributorNameQUuid]|reply_path -%}
      {%- set contributorName = repliesMap[contributorNamePath]|reply_str_value -%}
      
      {%- if whichContributor == 0 -%}
        <tr>
          <th> Contributor(s) </th>
          <td>{{ contributorName }}  </td>
        </tr>
      {%- else -%}
        <tr>
          <th> </th>
          <td>{{ contributorName }}  </td>
        </tr>
      {%- endif -%}
    {%- endfor -%}
    {%- set methodPath = [uuids.adminDetailsCUuid, uuids.methodQUuid]|reply_path -%}
    {%- set method = repliesMap[methodPath]|reply_str_value -%}

    {%- if method -%}
      <tr>
        <th> Method followed to carry out the DPIA </th>
        <td> {{ method }} </td>
      </tr>
    {%- endif -%} 
    
    {%- set infoSystemToolQPath = [uuids.adminDetailsCUuid, uuids.infoSystemToolQUuid]|reply_path -%}
    {%- set reply = repliesMap[infoSystemToolQPath] -%}
    {%- set replyValue = reply|reply_str_value -%}

    {%- if replyValue -%}
      {%- set answer = km.entities.answers[replyValue] -%}
      <tr>
        <th> Is a research information system used to support the DPIA? </th>
        <td> {{answer.label}}  </td>
      </tr>
    {%- endif -%} 

  
    {%- set riskAssessToolQPath = [uuids.adminDetailsCUuid, uuids.riskAssessToolQUuid]|reply_path -%}
    {%- set reply = repliesMap[riskAssessToolQPath] -%}
    {%- set replyValue = reply|reply_str_value -%}
    
    {%- if replyValue -%}
      {%- set answer = km.entities.answers[replyValue] -%}
      <tr>
        <th> Is a risk assessment tool used to support the DPIA? </th>
        <td> {{answer.label}}  </td>
      </tr>
    {%- endif -%} 
</table>

<p class="tool-info">
  Report generated by Data Stewardship Wizard &lt;<a href="https://ds-wizard.org" target="_blank">https://ds-wizard.org</a>&gt;
</p>
</header>
